import{_ as i,c as a,a as n,o as t}from"./app-poPtaMJY.js";const e={};function p(l,s){return t(),a("div",null,s[0]||(s[0]=[n(`<h1 id="内网部署-umami" tabindex="-1"><a class="header-anchor" href="#内网部署-umami"><span>内网部署 umami</span></a></h1><p>内网部署了一个 WiKi，为了简便，使用的 VuePress + <a href="https://theme-hope.vuejs.press/" target="_blank" rel="noopener noreferrer">Hope 主题</a>。<br> 估计是内部试用版的原因，基本上没人看。更主要是除了我自己，也没人往上放东西。。。<br> 不过，本着网站功能齐全的目标，想者加一个统计功能，顺带看看是不是真的只有我一个人在用。。。</p><h2 id="安装" tabindex="-1"><a class="header-anchor" href="#安装"><span>安装</span></a></h2><p>本着能省则省的原则，首先看了下是否有 docker 版。挺好，有 docker 版，遂采用了 docker 版。</p><p>docker compose 文件参考了这里：<a href="https://homulilly.com/post/use-docker-deploy-umami.html" target="_blank" rel="noopener noreferrer">使用 Docker 部署 Umami 网站访问统计系统</a></p><p>docker 镜像下载折腾了不少时间（没可用的镜像），这里略去不表。。。</p><p>启动完了后，看到了自己映射的端口，同时也开放了该端口，但仍然不能访问。<br> 然后使用 <code>docker logs</code> 查看了一下，虽然最后显示成功，但是中间有个下载出错了。</p><p>由于是内网环境，该服务器没法联网。遂上网搜了一下有无类似 <code>SCSS</code> 之类的设置 url 的方式。<br> 找到了一个解决方案：<a href="https://blog.bg7zag.com/2852" target="_blank" rel="noopener noreferrer">解决 prisma 国内部署失败</a></p><p>遂按照其方式，改造了一下 compose 文件。</p><div class="language-yaml" data-highlighter="shiki" data-ext="yaml" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-yaml"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">services</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  umami</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    image</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">umami-software/umami:postgresql-latest</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    ports</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      - </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">11030:3000</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    environment</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      # 使用自己的密码替换 &lt;db_passwd&gt;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      DATABASE_URL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">postgresql://umami:&lt;db_passwd&gt;@db:5432/umami</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      DATABASE_TYPE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">postgresql</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      # 生成一段随机字符串替换 &lt;app_secret&gt;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      # openssl rand -base64 32</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      APP_SECRET</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">NVHYhP3wYaMM14d8hGFfR3aCCmsSi2+cQ/LKLfV67V0=</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      # 下载 prisma 引擎失败</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      # https://blog.bg7zag.com/2852</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      PRISMA_QUERY_ENGINE_LIBRARY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/tmp/prisma/libquery_engine.so.node</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      # PRISMA_QUERY_ENGINE_BINARY: /tmp/prisma/query-engine</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      PRISMA_SCHEMA_ENGINE_BINARY</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">/tmp/prisma/schema-engine</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      # PRISMA_FMT_BINARY: /tmp/prisma/prisma-fmt</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    volumes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      - </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">./prisma/:/tmp/prisma</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    depends_on</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      db</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        condition</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">service_healthy</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    init</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    restart</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">always</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    healthcheck</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      test</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: [</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">CMD-SHELL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;curl http://localhost:3000/api/heartbeat&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      interval</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">5s</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      timeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">5s</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      retries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">5</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">  db</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    image</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">postgres:16-alpine</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    environment</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      POSTGRES_DB</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">umami</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      POSTGRES_USER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">umami</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      # 与前面生成的 &lt;db_passwd&gt; 一致</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      POSTGRES_PASSWORD</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&lt;db_passwd&gt;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    volumes</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      # 数据文件保存在 docker-compose.yaml 所在目?下的 data 文件?</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      - </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">./data:/var/lib/postgresql/data</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    restart</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">always</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    healthcheck</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      test</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: [</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">CMD-SHELL</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&#39;pg_isready -U $\${POSTGRES_USER} -d $\${POSTGRES_DB}&#39;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      interval</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">5s</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      timeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">5s</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">      retries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">5</span></span></code></pre></div><p>由于下载链接不固定，所以实际做法是每次只让一个变量有效，然后得到它的链接手动下载下来，放到 volumes 下面。<br> 重启多次看效果，哪里出错了改哪里。</p><p>经试验，仅需要两个变量即可。其中，<code>schema-engine</code> 需要加上执行权限。</p><h2 id="问题" tabindex="-1"><a class="header-anchor" href="#问题"><span>问题</span></a></h2><p>使用过程中，发现浏览量特别大，而实际并没有那么多。起初不知道什么问题，后来发现浏览量是根据 hash 统计的，同一个页面里 hash 变了的话，浏览量就会增加。</p><p>由于部署的 vuepress 并不是单页应用，所以不需要按 hash 统计浏览量。</p><p>有两种解决方式，一个是修改 <a href="https://umami.is/docs/environment-variables" target="_blank" rel="noopener noreferrer">环境变量</a> <code>REMOVE_TRAILING_SLASH = 1</code>。</p><p>另一个是修改 <a href="https://umami.is/docs/tracker-configuration" target="_blank" rel="noopener noreferrer">跟踪配置</a> <code>data-exclude-hash=&quot;true&quot;</code>。</p>`,17)]))}const k=i(e,[["render",p]]),r=JSON.parse('{"path":"/posts/dev/umami-docker.html","title":"内网部署 umami","lang":"zh-CN","frontmatter":{"article":true,"date":"2025-07-24T00:00:00.000Z","category":["dev"],"tag":["dev","开发","umami"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"内网部署 umami\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-07-24T00:00:00.000Z\\",\\"dateModified\\":\\"2025-07-30T09:30:14.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Zhao Bin\\",\\"url\\":\\"zhaobc.site\\",\\"email\\":\\"hi@zhaobc.site\\"}]}"],["meta",{"property":"og:url","content":"https://www.zhaobc.site/posts/dev/umami-docker.html"}],["meta",{"property":"og:site_name","content":"赵斌的小站"}],["meta",{"property":"og:title","content":"内网部署 umami"}],["meta",{"property":"og:description","content":"内网部署 umami 内网部署了一个 WiKi，为了简便，使用的 VuePress + Hope 主题。 估计是内部试用版的原因，基本上没人看。更主要是除了我自己，也没人往上放东西。。。 不过，本着网站功能齐全的目标，想者加一个统计功能，顺带看看是不是真的只有我一个人在用。。。 安装 本着能省则省的原则，首先看了下是否有 docker 版。挺好，有 d..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-07-30T09:30:14.000Z"}],["meta",{"property":"article:tag","content":"umami"}],["meta",{"property":"article:tag","content":"开发"}],["meta",{"property":"article:tag","content":"dev"}],["meta",{"property":"article:published_time","content":"2025-07-24T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-07-30T09:30:14.000Z"}],["meta",{"name":"description","content":"内网安装 部署 umami docker"}],["link",{"rel":"alternate","type":"application/rss+xml","href":"https://www.zhaobc.site/rss.xml","title":"赵斌的小站 RSS Feed"}]],"description":"内网部署 umami 内网部署了一个 WiKi，为了简便，使用的 VuePress + Hope 主题。 估计是内部试用版的原因，基本上没人看。更主要是除了我自己，也没人往上放东西。。。 不过，本着网站功能齐全的目标，想者加一个统计功能，顺带看看是不是真的只有我一个人在用。。。 安装 本着能省则省的原则，首先看了下是否有 docker 版。挺好，有 d..."},"git":{"createdTime":1753352926000,"updatedTime":1753867814000,"contributors":[{"name":"Zhao Bin","username":"","email":"413853119@qq.com","commits":2}]},"readingTime":{"minutes":2.36,"words":707},"filePathRelative":"posts/dev/umami-docker.md","excerpt":"\\n<p>内网部署了一个 WiKi，为了简便，使用的 VuePress + <a href=\\"https://theme-hope.vuejs.press/\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">Hope 主题</a>。<br>\\n估计是内部试用版的原因，基本上没人看。更主要是除了我自己，也没人往上放东西。。。<br>\\n不过，本着网站功能齐全的目标，想者加一个统计功能，顺带看看是不是真的只有我一个人在用。。。</p>\\n<h2>安装</h2>\\n<p>本着能省则省的原则，首先看了下是否有 docker 版。挺好，有 docker 版，遂采用了 docker 版。</p>","autoDesc":true}');export{k as comp,r as data};
